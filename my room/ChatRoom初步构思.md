# **ChatRoom初步构思**

![image-20220712115302120](/home/yanran/.config/Typora/typora-user-images/image-20220712115302120.png)

##### 客户端

ChatClient.java -> 客户端窗口

​								发起连接

​								关闭

​								聊天

##### 服务器端

ChatServer.java -> 启动服务器端口并监听

ServerFrame.java -> 服务器窗口

ServerProcess.java -> 服务器与客户端的处理 -> 登陆

​																				   注册

​																			       发送信息

​																				   退出

------



- 用户注册、登陆、注销（7.19设计-----7.20完成）

------



> - ##### 数据库表的构建：（7.20）
>
> *应该根据系统架构中的组件划分，针对每个组件所处理的业务进行组件单元的数据库设计；不同组件间所对应的数据库表之间的关联应尽可能减少，如果不同组件间的表需要外键关联也尽量不要创建外键关联，而只是记录关联表的一个主键，确保组件对应的表之间的独立性，为系统或表结构的重构提供可能性。*

**群聊列表和好友列表避免一个用户/一个群创建一个表** 

- [x] 用户数据表 （注册后放到这里面）**client**--> id、username、password、state（初始0为离线，1为在线）

- [ ] 好友列表 （*互为好友关系*时两人放到此表的同一行里）**friend_list** -->  user1（用户1），user2（用户2），type（属性：0普通好友，1为消息屏蔽(黑名单)好友），send（发送申请方），yes（接收申请方）

- [ ] 群聊列表 **group_list** -->  groupname、users、type（身份属性：群主为0，管理员为2，群众为1）

  一个对应一个群聊名对应一个群内身份，需要调用时直接使用共性查找 

- [ ] 聊天记录的存储用一个表来记录（输入好友名发起聊天）**history_msg** -->   id，fromc（发送方），toc（接收方），msg_type（消息类型），msg（消息内容），sendtime（发送时间），

  state --> 消息状态，0：对方在线，已发送；1对方离线，可用于1登陆主页面显示未读消息数量2选择查看页面，显示未读消息内容（查看完未读消息后把state设置为0）

- [ ] 群聊记录：一个群一个id，然后所有群记录放在同个表里，按照id区分，调用查看id即可（索引） --> GroupMsg 

  

------

!(/home/yanran/.config/Typora/typora-user-images/image-20220727121617068.png)

![image-20220727121020667](/home/yanran/.config/Typora/typora-user-images/image-20220727121020667.png)

![image-20220727110424181](/home/yanran/.config/Typora/typora-user-images/image-20220727110424181.png)

![image-20220727110440188](/home/yanran/.config/Typora/typora-user-images/image-20220727110440188.png)

![image-20220727110507738](/home/yanran/.config/Typora/typora-user-images/image-20220727110507738.png)

- 框架以及页面选项设计（7.20设计-----7.25完成账户页面功能-----）

  

  通过channel发消息

  **问题：**

- [x] 先启动服务端再启动客户端，两边成功连接后在客户端启动Logn.run()调出用户登陆页面。登陆成功后给服务器端发送XXX上线，**退出登陆同样给服务端发XXX离线，但现在是需要完全退出系统关闭通道，服务端才会报“离线”**。（已解决：将shutdownGracefully放到closeFuture前面去就OK）

- [x] **不可以同时登陆两个帐号**（已解决：数据库中用户表的state，输入用户名之后遍历state值为1的name，如果有重复就显示在线不能重复登陆）
- [ ] （直接关闭程序进程后退出不会i导致state还原为0，会影响下次登陆）
- [x] 登陆成功后拿到当前登陆帐号的username
- [x] 黑名单 
- [ ] 输出好友列表的时候顺带输出它的状态（需要连接两个表查询，后面再补充吧）
- [x] 添加黑名单好友的时候多一个“退出”操作（后面再补）
- [ ] 数据库连接池
- [ ] 枚举 密码加密

- [ ] ctrl D和ctrl C的屏蔽

- [x] 数据库连接应该在服务端

  客户端向服务器端发出申请

- [ ] 用户登陆后页面显示（登陆成功后将状态改为在线，接收消息只存入“消息历史记录”表中）

- [ ] 私聊、群聊、文件传输的实现都是**由客户端发到服务器，再由服务器发送到目标客户端**

- [ ] **关于发消息：**登陆的时候一个帐号名绑定一个channel，发送消息时通过帐号名查找到对应的channel，然后通过服务器发送消息

  ```java
  // 启动客户端,等待连接服务端,同时将异步改为同步
  ChannelFuture channelFuture = bootstrap.connect(ip,port).sync();
  Channel channel = channelFuture.channel();
  System.out.println("-------" +nchannel.localAddress().toString().substring(1) + "--------");
  
  // 输入
  Scanner input = new Scanner(System.in);
  
  while (input.hasNextLine()) {
  	String msg = input.nextLine();
  	//向服务端发送消息
  	channel.writeAndFlush(msg);
  }
  ```

------

**-----------您有？条未读消息-----------**

**（A）好友管理**

​					**查看好友列表**

​					**查看黑名单**  添加黑名单好友、删除黑名单好友 

​					**添加好友**：【请输入您想要添加的好友名字】 --- 【是否确定添加为好友？】--- **（是）**发给服务端判断client中是否存在此人 ---> 再判断此人是否在自己的好友列表中 ---> 给对方*发送好友请求*【发送成功，等待对方验证中】、**（否）**【您已取消操作】

​					**删除好友**

**（B）聊天群管理**

​					**查看我加入的群列表**

​									***我加入的群***（群众1）--- 列出群列表 --- 请输入想要查看的群名 -

​									***我创建的群***（群主0）

​												**解散群聊**

​												**添加群管理员**

​												**删除群管理员**

​												查看加入群的群成员列表

​									***我创建的群***（管理员2）

​												查看加入群的群成员列表

​					**创建新的群聊**

​					**申请加入群聊**

​					**退出群聊**

**（C）好友聊天**

​					**发起聊天**

发起聊天：先列出非黑名单的好友列表
再选择想要聊天的对象（输入对方名字）
显示（打印）与对方的历史记录：名字 发送时间 发送内容
打印完开始发送消息（发给服务端，服务端进行转发）

用户1...给用户2...发送消息中



判断用户2是否在线 --> 不在线（数据存入历史消息表和离线消息表中）在线（仅存入历史消息表中，然后给用户2发送【收到好友1的一条消息：msg】）

​					**查看聊天记录**

查找from 查

**（D）群聊天**

​					**发起聊天**

​					**查看聊天记录**

**（E）消息管理**

​					**未读消息**（就是离线后收到的消息，结束之后立刻将消息列表清空）

​					**查看好友请求**

​					**查看群通知**

​						**我的群申请 **--- 您已加入群聊.../ 您加入群聊...的申请被驳回

​					**我管理的群通知**（群主0和管理员2能收到）

​									群申请 --- 选择同意/不同意

​									设置管理员通知 ---- 您已被群主设置为群...的管理员 / 您已被群主解除群...管理员身份

​									群友退出 --- XXX退出了群聊

**（F）退出登陆**（将接收消息数据表改为未读消息表，状态改为离线）





